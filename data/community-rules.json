[
  {
    "mitre_id": "T1110.001",
    "title": "Login Failed",
    "author": "Luigi",
    "siem_tags": ["Sentinel", "SecurityEvent", "KQL"],
    "subtechniques": [],
    "rules": [
      {
        "type": "Sentinel KQL",
        "lang": "sentinel",
        "code": "let threshold=99;\nSecurityEvent\n| where EventID == 4625 and AccountType == \"User\"\n| project Account, Computer, IpAddress\n| summarize LogonFailed = count() by Computer, Account, IpAddress\n| where LogonFailed > threshold"
      }
    ]
  },
  {
    "mitre_id": "T1110.002",
    "title": "Login Failed with Multiple Details",
    "author": "Luigi",
    "siem_tags": ["Sentinel", "SecurityEvent", "KQL"],
    "subtechniques": [],
    "rules": [
      {
        "type": "Sentinel KQL",
        "lang": "sentinel",
        "code": "let threshold = 99;\nSecurityEvent\n| where EventID == 4625 and AccountType == \"User\"\n| project Account, Computer, IpAddress, LogonType, FailureReason\n| summarize \n    AttemptsFailed = count(),\n    LogonTypes = make_set(LogonType),\n    FailureReasons = make_set(FailureReason)\n    by Computer, Account, IpAddress\n| summarize \n    TotalAttempts = sum(AttemptsFailed),\n    Ncomputer = dcount(Computer),\n    Naccount  = dcount(Account),\n    NipAddress = dcount(IpAddress),\n    Details = make_list(pack(\"User\", Account, \"IP\", IpAddress, \"Attempts\", AttemptsFailed, \"LogonType\", LogonTypes, \"FailureReason\", FailureReasons))\n    by Computer\n| where TotalAttempts > threshold"
      }
    ]
  },
  {
    "mitre_id": "T1110.003",
    "title": "Multiple Login Failures",
    "author": "Luigi",
    "siem_tags": ["Sentinel", "SecurityEvent", "KQL"],
    "subtechniques": [],
    "rules": [
      {
        "type": "Sentinel KQL",
        "lang": "sentinel",
        "code": "let threshold = 99;\nSecurityEvent\n| where EventID == 4625 and AccountType == \"User\"\n| project Account, Computer, IpAddress\n| summarize LogonFailed = count() by Computer, Account, IpAddress\n| summarize \n    TotalAttempts = sum(LogonFailed),\n    UserIP_Map = make_list(pack(\"User\", Account, \"IP\", IpAddress, \"Count\", LogonFailed)),\n    DistinctUsers = dcount(Account),\n    DistinctIPs = dcount(IpAddress)\n    by Computer\n| where TotalAttempts > threshold and DistinctUsers > 1 and DistinctIPs > 1"
      }
    ]
  },
  {
    "mitre_id": "T1110.004",
    "title": "Multiple Login Failures to Same Destination",
    "author": "Luigi",
    "siem_tags": ["Sentinel", "SecurityEvent", "KQL"],
    "subtechniques": [],
    "rules": [
      {
        "type": "Sentinel KQL",
        "lang": "sentinel",
        "code": "let threshold = 99;\nSecurityEvent\n| where EventID == 4625 and AccountType == \"User\"\n| project Account, Computer, IpAddress\n| summarize Attempts = count() by Account, IpAddress, Computer\n| summarize \n    AttemptsFailed = sum(Attempts),\n    NumAccount = dcount(Account),\n    NumIp = dcount(IpAddress),\n    Details = make_list(pack(\"User\", Account, \"IP\", IpAddress, \"Attempts\", Attempts))\n    by Computer\n| where AttemptsFailed > threshold and (NumAccount > 1 or NumIp > 1)"
      }
    ]
  },
  {
    "mitre_id": "T1110.005",
    "title": "Login Failed via RDP",
    "author": "Luigi",
    "siem_tags": ["Sentinel", "SecurityEvent", "KQL", "RDP"],
    "subtechniques": [],
    "rules": [
      {
        "type": "Sentinel KQL",
        "lang": "sentinel",
        "code": "let threshold=5;\nSecurityEvent\n| where TimeGenerated > ago(1h)\n| where EventID == 4625 and LogonType == 10\n| summarize Attempts = count() by Account, IpAddress, Computer,FailureReason\n| summarize Attempts = sum(Attempts),\n            UserIP_Map = make_list(pack(\"User\", Account, \"IP\", IpAddress, \"Count\", Attempts,\"FailureReason\", FailureReason)),\n            DistinctUsers = dcount(Account),\n            DistinctIPs = dcount(IpAddress)\n          by Computer\n| where Attempts > threshold"
      }
    ]
  },
  {
    "mitre_id": "T1110.006",
    "title": "Password Spray from Single IP on Multiple Accounts",
    "author": "Luigi",
    "siem_tags": ["Sentinel", "SecurityEvent", "KQL", "Password"],
    "subtechniques": [],
    "rules": [
      {
        "type": "Sentinel KQL",
        "lang": "sentinel",
        "code": "let thresholdUsers = 2;\nlet thresholdAttempts = 5;\nSecurityEvent\n| where EventID == 4625 and AccountType == \"User\"\n| summarize Attempts = count() by Account, IpAddress\n| where Attempts <= thresholdAttempts\n| summarize \n    DistinctUsers = dcount(Account),\n    TotalAttempts = sum(Attempts),\n    Details = make_list(pack(\"User\", Account, \"Attempts\", Attempts))\n    by IpAddress\n| where DistinctUsers > thresholdUsers"
      }
    ]
  },
  {
    "mitre_id": "T1110.007",
    "title": "Login Failures on Single Account from Multiple IPs",
    "author": "Luigi",
    "siem_tags": ["Sentinel", "SecurityEvent", "KQL", "IP"],
    "subtechniques": [],
    "rules": [
      {
        "type": "Sentinel KQL",
        "lang": "sentinel",
        "code": "let thresholdIPs = 5;\nSecurityEvent\n| where EventID == 4625 and AccountType == \"User\"\n| summarize Attempts = count() by Account, IpAddress\n| summarize \n    DistinctIPs = dcount(IpAddress),\n    TotalAttempts = sum(Attempts),\n    IPs = make_set(IpAddress)\n    by Account\n| where DistinctIPs > thresholdIPs"
      }
    ]
  },
  {
    "mitre_id": "T1110.008",
    "title": "Login Outside Business Hours",
    "author": "Luigi",
    "siem_tags": ["Sentinel", "SecurityEvent", "KQL", "Time"],
    "subtechniques": [],
    "rules": [
      {
        "type": "Sentinel KQL",
        "lang": "sentinel",
        "code": "let WorkStart = 8;\nlet WorkEnd = 18;\nSecurityEvent\n| where EventID == 4624 and AccountType == \"User\"\n| extend LogonHour = datetime_part(\"hour\", TimeGenerated),\n         LogonMinute = datetime_part(\"minute\", TimeGenerated)\n| where LogonHour < WorkStart or LogonHour >= WorkEnd\n| summarize count() by Account, IpAddress, Computer, LogonHour,LogonMinute"
      }
    ]
  },
  {
    "mitre_id": "T1110.009",
    "title": "Multiple Failed Logons Followed by Success",
    "author": "Luigi",
    "siem_tags": ["Sentinel", "SecurityEvent", "KQL"],
    "subtechniques": [],
    "rules": [
      {
        "type": "Sentinel KQL",
        "lang": "sentinel",
        "code": "let window = 10m;\nlet failedLogons = SecurityEvent\n| where EventID == 4625 and AccountType == \"User\" \n| project TimeFailed = TimeGenerated, Account, Computer, FailureReason;\nlet successfulLogons = SecurityEvent\n| where EventID == 4624 and AccountType == \"User\" \n| project TimeSuccess = TimeGenerated, Account, Computer;\nfailedLogons\n| join kind=inner (successfulLogons) on Account, Computer\n| where TimeSuccess >= TimeFailed\n  and TimeSuccess <= datetime_add('minute', 10, TimeFailed)\n| summarize \n    Attempts = count(),\n    Failures = make_set(pack(\"TimeFailed\", TimeFailed, \"Reason\", FailureReason)),\n    Successes = make_set(pack(\"TimeSuccess\", TimeSuccess))\n  by Account, Computer\n| where Attempts > 10"
      }
    ]
  },
  {
    "mitre_id": "T1110.009",
    "title": "Multiple Failed Logons Followed by Success",
    "author": "Luigi",
    "siem_tags": ["Qradar", "SecurityEvent", "AQL"],
    "subtechniques": [],
    "rules": [
      {
        "type": "Qradar",
        "lang": "qradar",
        "code": "let window = 10m;\nlet failedLogons = SecurityEvent\n| where EventID == 4625 and AccountType == \"User\" \n| project TimeFailed = TimeGenerated, Account, Computer, FailureReason;\nlet successfulLogons = SecurityEvent\n| where EventID == 4624 and AccountType == \"User\" \n| project TimeSuccess = TimeGenerated, Account, Computer;\nfailedLogons\n| join kind=inner (successfulLogons) on Account, Computer\n| where TimeSuccess >= TimeFailed\n  and TimeSuccess <= datetime_add('minute', 10, TimeFailed)\n| summarize \n    Attempts = count(),\n    Failures = make_set(pack(\"TimeFailed\", TimeFailed, \"Reason\", FailureReason)),\n    Successes = make_set(pack(\"TimeSuccess\", TimeSuccess))\n  by Account, Computer\n| where Attempts > 10"
      }
    ]
  },

  {
    "mitre_id": "T1087.002",
    "title": "AD User Enumeration — net user /domain",
    "author": "Luigi",
    "details": "Detects usage of net.exe to enumerate domain users.",
    "siem_tags": ["Active Directory", "Recon", "User Enumeration"],
    "subtechniques": ["T1087.002"],
    "rules": [
      {
        "lang": "kql",
        "type": "detection",
        "code": "let timeframe = 7d;\nDeviceProcessEvents\n| where Timestamp > ago(timeframe)\n| where FileName =~ \"net.exe\"\n| where ProcessCommandLine has \"user\" and ProcessCommandLine has \"/domain\"\n| project Timestamp, DeviceName, FileName, InitiatingProcessFileName, AccountName, ProcessCommandLine, ReportId\n| sort by Timestamp desc"
      }
    ]
  },
  {
    "mitre_id": "T1069.002",
    "title": "AD Group Enumeration — net group /domain",
    "author": "Luigi",
    "details": "Detects enumeration of domain groups using net.exe.",
    "siem_tags": ["Active Directory", "Recon", "Group Enumeration"],
    "subtechniques": ["T1069.002"],
    "rules": [
      {
        "lang": "kql",
        "type": "detection",
        "code": "let timeframe = 7d;\nDeviceProcessEvents\n| where Timestamp > ago(timeframe)\n| where FileName =~ \"net.exe\"\n| where ProcessCommandLine has \"group\" and ProcessCommandLine has \"/domain\"\n| project Timestamp, DeviceName, FileName, InitiatingProcessFileName, AccountName, ProcessCommandLine, ReportId\n| sort by Timestamp desc"
      }
    ]
  },
  {
    "mitre_id": "T1087",
    "title": "AD Domain Enumeration via .NET",
    "author": "Luigi",
    "details": "Detects PowerShell calls to the .NET API for retrieving domain information.",
    "siem_tags": ["Recon", ".NET", "PowerShell"],
    "subtechniques": ["T1087"],
    "rules": [
      {
        "lang": "kql",
        "type": "detection",
        "code": "let timeframe = 7d;\nDeviceProcessEvents\n| where Timestamp > ago(timeframe)\n| where tolower(FileName) in (\"powershell.exe\",\"pwsh.exe\")\n| where ProcessCommandLine contains \"[System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain\"\n| project Timestamp, DeviceName, FileName, AccountName, ProcessCommandLine, InitiatingProcessFileName, ReportId\n| sort by Timestamp desc"
      }
    ]
  },
  {
    "mitre_id": "T1257",
    "title": "LDAP Enumeration with DirectorySearcher",
    "author": "Luigi",
    "details": "Detects PowerShell instantiation of DirectorySearcher for LDAP reconnaissance.",
    "siem_tags": ["LDAP", "Recon", "PowerShell"],
    "subtechniques": ["T1257", "T1087"],
    "rules": [
      {
        "lang": "kql",
        "type": "detection",
        "code": "let timeframe = 7d;\nDeviceProcessEvents\n| where Timestamp > ago(timeframe)\n| where tolower(FileName) in (\"powershell.exe\",\"pwsh.exe\")\n| where ProcessCommandLine contains \"System.DirectoryServices.DirectorySearcher\"\n| project Timestamp, DeviceName, FileName, AccountName, ProcessCommandLine, InitiatingProcessFileName, ReportId\n| sort by Timestamp desc"
      }
    ]
  },
  {
    "mitre_id": "T1087",
    "title": "PowerView — Get-NetDomain",
    "author": "Luigi",
    "details": "Detects PowerView usage: Get-NetDomain.",
    "siem_tags": ["PowerView", "Recon", "AD"],
    "subtechniques": ["T1087"],
    "rules": [
      {
        "lang": "kql",
        "type": "detection",
        "code": "let timeframe = 7d;\nDeviceProcessEvents\n| where Timestamp > ago(timeframe)\n| where tolower(FileName) in (\"powershell.exe\",\"pwsh.exe\")\n| where ProcessCommandLine has \"Get-NetDomain\"\n| project Timestamp, DeviceName, FileName, AccountName, ProcessCommandLine, InitiatingProcessFileName, ReportId\n| sort by Timestamp desc"
      }
    ]
  },
  {
  "mitre_id": "T1087.003",
  "title": "AD Computer Enumeration — Get-NetComputer",
  "author": "Luigi",
  "details": "Detects the enumeration of domain computers using Get-NetComputer.",
  "siem_tags": ["Recon", "AD", "PowerView"],
  "subtechniques": ["T1087.003"],
  "rules": [
    {
      "lang": "kql",
      "type": "detection",
      "code": "let timeframe = 7d;\nDeviceProcessEvents\n| where Timestamp > ago(timeframe)\n| where tolower(FileName) in (\"powershell.exe\",\"pwsh.exe\")\n| where ProcessCommandLine has \"Get-NetComputer\"\n| project Timestamp, DeviceName, FileName, AccountName, ProcessCommandLine, InitiatingProcessFileName, ReportId\n| sort by Timestamp desc"
    }
  ]
},
{
  "mitre_id": "T1558.003",
  "title": "SPN Enumeration — Get-NetUser -SPN",
  "author": "Luigi",
  "details": "Detects PowerView Get-NetUser -SPN used to enumerate SPNs.",
  "siem_tags": ["Kerberoast", "Recon", "SPN", "PowerView"],
  "subtechniques": ["T1558.003"],
  "rules": [
    {
      "lang": "kql",
      "type": "detection",
      "code": "let timeframe = 7d;\nDeviceProcessEvents\n| where Timestamp > ago(timeframe)\n| where tolower(FileName) in (\"powershell.exe\",\"pwsh.exe\")\n| where ProcessCommandLine has \"Get-NetUser\" and ProcessCommandLine has \"SPN\"\n| project Timestamp, DeviceName, FileName, AccountName, ProcessCommandLine, InitiatingProcessFileName, ReportId\n| sort by Timestamp desc"
    }
  ]
},
{
  "mitre_id": "T1558.003",
  "title": "SPN Enumeration — setspn -L",
  "author": "Luigi",
  "details": "Detects SPN enumeration with setspn.exe, used for Kerberoasting reconnaissance.",
  "siem_tags": ["Kerberoast", "Recon", "SPN"],
  "subtechniques": ["T1558.003"],
  "rules": [
    {
      "lang": "kql",
      "type": "detection",
      "code": "let timeframe = 7d;\nDeviceProcessEvents\n| where Timestamp > ago(timeframe)\n| where tolower(FileName) =~ \"setspn.exe\"\n| where ProcessCommandLine has \"-l\" or ProcessCommandLine has \"-L\"\n| project Timestamp, DeviceName, FileName, AccountName, ProcessCommandLine, InitiatingProcessFileName, ReportId\n| sort by Timestamp desc"
    }
  ]
},
{
  "mitre_id": "T1069",
  "title": "Object Permission Enumeration — Get-ObjectAcl",
  "author": "Luigi",
  "details": "Detects permission/ACL collection for reconnaissance.",
  "siem_tags": ["Recon", "PowerView", "ACL"],
  "subtechniques": ["T1069"],
  "rules": [
    {
      "lang": "kql",
      "type": "detection",
      "code": "let timeframe = 7d;\nDeviceProcessEvents\n| where Timestamp > ago(timeframe)\n| where tolower(FileName) in (\"powershell.exe\",\"pwsh.exe\")\n| where ProcessCommandLine has \"Get-ObjectAcl\"\n| project Timestamp, DeviceName, FileName, AccountName, ProcessCommandLine, InitiatingProcessFileName, ReportId\n| sort by Timestamp desc"
    }
  ]
},
{
  "mitre_id": "T1135",
  "title": "Domain Share Enumeration — Find-DomainShare",
  "author": "Luigi",
  "details": "Detects Find-DomainShare usage for discovering domain shares.",
  "siem_tags": ["Recon", "PowerView", "Shares"],
  "subtechniques": ["T1135"],
  "rules": [
    {
      "lang": "kql",
      "type": "detection",
      "code": "let timeframe = 7d;\nDeviceProcessEvents\n| where Timestamp > ago(timeframe)\n| where tolower(FileName) in (\"powershell.exe\",\"pwsh.exe\")\n| where ProcessCommandLine has \"Find-DomainShare\"\n| project Timestamp, DeviceName, FileName, AccountName, ProcessCommandLine, InitiatingProcessFileName, ReportId\n| sort by Timestamp desc"
    }
  ]
}
]
